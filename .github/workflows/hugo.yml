name: Deploy Blog + Angular Apps

on:
  push:
    branches: [main]
  repository_dispatch:
    types: [angular-app-updated]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ Register all Angular apps here.                         ‚îÇ
  # ‚îÇ Format: owner/repo|subpath|release-tag                  ‚îÇ
  # ‚îÇ                                                         ‚îÇ
  # ‚îÇ - subpath: where the app is served (e.g., /app-one/)    ‚îÇ
  # ‚îÇ - release-tag: the tag name used in the Angular repo's  ‚îÇ
  # ‚îÇ   release (typically 'latest-build')                    ‚îÇ
  # ‚îÇ                                                         ‚îÇ
  # ‚îÇ Add one line per Angular app.                           ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ANGULAR_APPS: |
    yringler/ANGULAR_REPO_ONE|app-one|latest-build
    yringler/ANGULAR_REPO_TWO|app-two|latest-build

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.155.3
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # ‚îÄ‚îÄ Fetch all Angular apps from their releases ‚îÄ‚îÄ

      - name: Fetch Angular app releases
        id: fetch-apps
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_PAT }}
          script: |
            const fs = require('fs');
            const lines = process.env.ANGULAR_APPS.trim().split('\n').filter(l => l.trim());
            const results = [];

            for (const line of lines) {
              const [repo, subpath, tag] = line.trim().split('|');
              const [owner, repoName] = repo.split('/');
              core.info(`Fetching ${repo} (tag: ${tag}) ‚Üí /${subpath}/`);

              try {
                const release = await github.rest.repos.getReleaseByTag({
                  owner, repo: repoName, tag
                });

                const asset = release.data.assets.find(a => a.name === 'angular-dist.tar.gz');
                if (!asset) {
                  core.warning(`${repo}: release '${tag}' exists but has no angular-dist.tar.gz asset`);
                  results.push({ repo, subpath, tag, found: false });
                  continue;
                }

                core.info(`${repo}: downloading asset (${asset.size} bytes, uploaded ${asset.updated_at})`);

                const download = await github.rest.repos.getReleaseAsset({
                  owner, repo: repoName,
                  asset_id: asset.id,
                  headers: { accept: 'application/octet-stream' }
                });

                const filename = `angular-${subpath}.tar.gz`;
                fs.writeFileSync(filename, Buffer.from(download.data));
                results.push({ repo, subpath, tag, found: true, filename });
                core.info(`${repo}: ‚úÖ downloaded`);
              } catch (err) {
                if (err.status === 404) {
                  core.warning(`${repo}: no release found with tag '${tag}'`);
                } else {
                  core.warning(`${repo}: fetch failed ‚Äî ${err.message}`);
                }
                results.push({ repo, subpath, tag, found: false });
              }
            }

            fs.writeFileSync('angular-manifest.json', JSON.stringify(results, null, 2));
            const needsBuild = results.filter(r => !r.found);
            core.setOutput('needs_fallback', needsBuild.length > 0 ? 'true' : 'false');

      # ‚îÄ‚îÄ Extract downloaded releases ‚îÄ‚îÄ

      - name: Extract Angular apps from releases
        run: |
          MANIFEST=$(cat angular-manifest.json)
          echo "$MANIFEST" | jq -c '.[] | select(.found == true)' | while read -r entry; do
            SUBPATH=$(echo "$entry" | jq -r '.subpath')
            FILENAME=$(echo "$entry" | jq -r '.filename')
            REPO=$(echo "$entry" | jq -r '.repo')

            echo "üì¶ Extracting ${REPO} ‚Üí angular-output/${SUBPATH}/"
            mkdir -p "angular-output/${SUBPATH}"
            tar -xzf "${FILENAME}" -C "angular-output/${SUBPATH}"
          done

      # ‚îÄ‚îÄ Fallback: build any apps that had no release ‚îÄ‚îÄ

      - name: Setup Node (fallback builds)
        if: steps.fetch-apps.outputs.needs_fallback == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build missing Angular apps from source
        if: steps.fetch-apps.outputs.needs_fallback == 'true'
        run: |
          MANIFEST=$(cat angular-manifest.json)
          echo "$MANIFEST" | jq -c '.[] | select(.found == false)' | while read -r entry; do
            REPO=$(echo "$entry" | jq -r '.repo')
            SUBPATH=$(echo "$entry" | jq -r '.subpath')

            echo "‚ö†Ô∏è Building ${REPO} from source ‚Üí angular-output/${SUBPATH}/"
            git clone "https://x-access-token:${{ secrets.CROSS_REPO_PAT }}@github.com/${REPO}.git" "src-${SUBPATH}"
            cd "src-${SUBPATH}"
            npm ci
            npx ng build --configuration production --base-href "/${SUBPATH}/"
            cd ..
            mkdir -p "angular-output/${SUBPATH}"
            # Angular 17+ outputs to dist/<project-name>/browser/
            cp -r src-${SUBPATH}/dist/*/browser/* "angular-output/${SUBPATH}/"
            rm -rf "src-${SUBPATH}"
            echo "‚úÖ Built ${REPO} from source"
          done

      # ‚îÄ‚îÄ Build Hugo ‚îÄ‚îÄ

      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26.0'

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: America/New_York
        run: |
          hugo \
            --gc \
            --minify \
            --baseURL "${{ steps.pages.outputs.base_url }}/"

      # ‚îÄ‚îÄ Combine and deploy ‚îÄ‚îÄ

      - name: Merge Angular apps into Hugo site
        run: |
          if [ -d angular-output ]; then
            cp -r angular-output/* public/
            echo "‚úÖ Combined site structure:"
            ls -la public/
            for dir in angular-output/*/; do
              name=$(basename "$dir")
              echo "  /${name}/: $(ls public/${name}/ | wc -l) files"
            done
          else
            echo "‚ÑπÔ∏è No Angular apps to merge"
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
